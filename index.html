import React, { useState, useEffect, useMemo, useRef, Component } from 'react';
import { 
  Home, 
  Package, 
  Users, 
  Plus, 
  Search, 
  ShoppingCart, 
  TrendingUp, 
  AlertCircle,
  ChevronRight,
  Wallet,
  X,
  Check,
  Download,
  Upload,
  Settings,
  ScanBarcode,
  Camera,
  Save,
  Smartphone,
  Trash2,
  Edit,
  MessageCircle,
  Clock,
  ArrowLeft
} from 'lucide-react';

// --- ERROR BOUNDARY (Prote√ß√£o contra Tela Branca) ---
class ErrorBoundary extends Component {
  constructor(props) { super(props); this.state = { hasError: false }; }
  static getDerivedStateFromError(error) { return { hasError: true }; }
  componentDidCatch(error, info) { console.error("Crash:", error, info); }
  render() {
    if (this.state.hasError) {
      return (
        <div className="flex flex-col items-center justify-center h-full p-6 text-center bg-slate-50 text-slate-900">
          <div className="text-6xl mb-4">ü§ï</div>
          <h2 className="text-xl font-bold mb-2">Ops! Algo deu errado.</h2>
          <button onClick={() => window.location.reload()} className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg">Recarregar</button>
        </div>
      );
    }
    return this.props.children;
  }
}

// --- DADOS INICIAIS ---
const INITIAL_PRODUCTS = [
  { id: 1, name: 'Malbec Desodorante Col√¥nia', brand: 'O Botic√°rio', category: 'Perfume', cost: 110.00, price: 190.00, stock: 3, barcode: '7891033785632' },
  { id: 2, name: 'Essencial Oud Masculino', brand: 'Natura', category: 'Perfume', cost: 130.00, price: 230.00, stock: 1, barcode: '7908056789012' },
  { id: 3, name: 'Kaiak Tradicional', brand: 'Natura', category: 'Perfume', cost: 80.00, price: 155.00, stock: 5, barcode: '7891234567890' },
];

const INITIAL_CUSTOMERS = [
  { id: 1, name: 'Maria Silva', phone: '11999999999', debt: 0, history: [] },
  { id: 2, name: 'Jo√£o Santos', phone: '11988888888', debt: 155.00, history: [] },
];

// --- UTILIT√ÅRIOS ---
const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
const formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });

// --- HOOK DE VOLTAR (Navega√ß√£o Mobile) ---
const useBackHandler = (isOpen, onClose) => {
  useEffect(() => {
    if (isOpen) {
      window.history.pushState({ modal: true }, '');
      const handlePopState = () => onClose();
      window.addEventListener('popstate', handlePopState);
      return () => {
        window.removeEventListener('popstate', handlePopState);
        if (window.history.state?.modal) window.history.back();
      };
    }
  }, [isOpen, onClose]);
};

// --- COMPONENTES UI ---
const StatCard = ({ title, value, icon: Icon, colorClass, bgClass }) => (
  <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
    <div>
      <p className="text-slate-500 text-xs font-bold uppercase mb-1 tracking-wide">{title}</p>
      <h3 className={`text-2xl font-bold ${colorClass}`}>{value}</h3>
    </div>
    <div className={`p-3 rounded-full ${bgClass}`}>
      <Icon className={`w-6 h-6 ${colorClass}`} />
    </div>
  </div>
);

const Toast = ({ message, type, onClose }) => {
  useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
  return (
    <div className={`fixed top-4 left-4 right-4 z-[100] p-4 rounded-xl shadow-2xl flex items-center justify-between animate-fade-in ${type === 'error' ? 'bg-rose-600 text-white' : 'bg-slate-900 text-white'}`}>
      <span className="font-bold text-sm flex-1 mr-2">{message}</span>
      <button onClick={onClose}><X className="w-5 h-5 opacity-70"/></button>
    </div>
  );
};

const ConfirmModal = ({ title, message, onConfirm, onCancel }) => (
  <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-6 backdrop-blur-sm">
    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
      <h3 className="text-xl font-bold text-slate-900 mb-2">{title}</h3>
      <p className="text-slate-500 mb-8 text-sm leading-relaxed">{message}</p>
      <div className="flex gap-3">
        <button onClick={onCancel} className="flex-1 py-3.5 text-slate-600 font-bold text-sm bg-slate-100 rounded-xl active:scale-95 transition-transform">Cancelar</button>
        <button onClick={onConfirm} className="flex-1 py-3.5 bg-purple-600 text-white font-bold text-sm rounded-xl shadow-lg active:scale-95 transition-transform">Confirmar</button>
      </div>
    </div>
  </div>
);

// --- FORMUL√ÅRIOS ISOLADOS ---
const ProductForm = ({ data, onSave, onCancel, onDelete }) => {
  const [form, setForm] = useState(data || { name: '', brand: '', stock: '', price: '', cost: '', barcode: '' });
  useBackHandler(true, onCancel);

  return (
    <div className="fixed inset-0 bg-slate-50 z-50 flex flex-col animate-slide-up">
      <div className="p-4 bg-white shadow-sm flex justify-between items-center pt-safe">
        <button onClick={onCancel} className="p-2 -ml-2 text-slate-400"><X className="w-6 h-6"/></button>
        <h2 className="font-bold text-lg text-slate-800">{data ? 'Editar' : 'Novo'} Produto</h2>
        <button onClick={() => onSave(form)} className="text-purple-600 font-bold text-sm">Salvar</button>
      </div>
      <div className="p-5 space-y-4 overflow-y-auto pb-20 custom-scrollbar">
        <div><label className="text-xs font-bold text-slate-400 uppercase">Nome</label><input className="w-full p-4 bg-white border border-slate-200 rounded-xl mt-1 font-medium text-slate-900 outline-none focus:border-purple-500" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Ex: Perfume X" /></div>
        <div className="flex gap-3">
          <div className="flex-1"><label className="text-xs font-bold text-slate-400 uppercase">Marca</label><input className="w-full p-4 bg-white border border-slate-200 rounded-xl mt-1 text-slate-900 outline-none focus:border-purple-500" value={form.brand} onChange={e => setForm({...form, brand: e.target.value})} /></div>
          <div className="w-1/3"><label className="text-xs font-bold text-slate-400 uppercase">Qtd</label><input type="number" inputMode="decimal" className="w-full p-4 bg-white border border-slate-200 rounded-xl mt-1 text-center font-bold text-slate-900 outline-none focus:border-purple-500" value={form.stock} onChange={e => setForm({...form, stock: e.target.value})} /></div>
        </div>
        <div className="flex gap-3">
          <div className="flex-1"><label className="text-xs font-bold text-slate-400 uppercase">Custo</label><input type="number" inputMode="decimal" className="w-full p-4 bg-white border border-slate-200 rounded-xl mt-1 text-slate-900 outline-none focus:border-purple-500" value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} placeholder="0.00" /></div>
          <div className="flex-1"><label className="text-xs font-bold text-slate-400 uppercase text-purple-600">Venda</label><input type="number" inputMode="decimal" className="w-full p-4 bg-white border-purple-200 rounded-xl mt-1 font-bold text-purple-700 outline-none focus:border-purple-500" value={form.price} onChange={e => setForm({...form, price: e.target.value})} placeholder="0.00" /></div>
        </div>
        <div><label className="text-xs font-bold text-slate-400 uppercase">C√≥digo</label><div className="flex gap-2 mt-1"><input className="flex-1 p-4 bg-white border border-slate-200 rounded-xl text-slate-900 outline-none focus:border-purple-500" value={form.barcode} onChange={e => setForm({...form, barcode: e.target.value})} placeholder="Opcional" /><button className="bg-slate-100 p-4 rounded-xl text-slate-500"><ScanBarcode className="w-6 h-6"/></button></div></div>
        {data && <button onClick={() => onDelete(data.id)} className="w-full py-4 mt-4 text-rose-500 font-bold bg-rose-50 rounded-xl flex items-center justify-center gap-2"><Trash2 className="w-5 h-5"/> Excluir Produto</button>}
      </div>
    </div>
  );
};

const CustomerForm = ({ data, onSave, onCancel, onDelete }) => {
  const [form, setForm] = useState(data || { name: '', phone: '' });
  useBackHandler(true, onCancel);

  return (
    <div className="fixed inset-0 bg-slate-50 z-50 flex flex-col animate-slide-up">
      <div className="p-4 bg-white shadow-sm flex justify-between items-center pt-safe">
        <button onClick={onCancel} className="p-2 -ml-2 text-slate-400"><X className="w-6 h-6"/></button>
        <h2 className="font-bold text-lg text-slate-800">{data ? 'Editar' : 'Novo'} Cliente</h2>
        <button onClick={() => onSave(form)} className="text-purple-600 font-bold text-sm">Salvar</button>
      </div>
      <div className="p-5 space-y-4">
        <input className="w-full p-4 bg-white border border-slate-200 rounded-xl text-slate-900 outline-none focus:border-purple-500" placeholder="Nome Completo" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
        <input type="tel" inputMode="tel" className="w-full p-4 bg-white border border-slate-200 rounded-xl text-slate-900 outline-none focus:border-purple-500" placeholder="Telefone (WhatsApp)" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} />
        {data && <button onClick={() => onDelete(data.id)} className="w-full py-4 mt-8 text-rose-500 font-bold bg-rose-50 rounded-xl flex items-center justify-center gap-2"><Trash2 className="w-5 h-5"/> Excluir</button>}
      </div>
    </div>
  );
};

// --- APP PRINCIPAL ---
export default function App() {
  const loadState = (key, def) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch { return def; } };
  const [products, setProducts] = useState(() => loadState('revenda_products', INITIAL_PRODUCTS));
  const [customers, setCustomers] = useState(() => loadState('revenda_customers', INITIAL_CUSTOMERS));
  const [transactions, setTransactions] = useState(() => loadState('revenda_transactions', []));

  useEffect(() => localStorage.setItem('revenda_products', JSON.stringify(products)), [products]);
  useEffect(() => localStorage.setItem('revenda_customers', JSON.stringify(customers)), [customers]);
  useEffect(() => localStorage.setItem('revenda_transactions', JSON.stringify(transactions)), [transactions]);

  const [activeTab, setActiveTab] = useState('home');
  const [productSearch, setProductSearch] = useState('');
  const [saleSearch, setSaleSearch] = useState('');

  const [productModal, setProductModal] = useState({ open: false, data: null });
  const [customerModal, setCustomerModal] = useState({ open: false, data: null });
  const [checkoutOpen, setCheckoutOpen] = useState(false);
  const [scanner, setScanner] = useState({ open: false, context: null });
  const [installModal, setInstallModal] = useState(false);
  const [toast, setToast] = useState(null);
  const [confirmDialog, setConfirmDialog] = useState(null);

  const [cart, setCart] = useState([]);
  const [saleType, setSaleType] = useState('cash');
  const [selectedCustomer, setSelectedCustomer] = useState(null);

  const showToast = (msg, type = 'success') => setToast({ message: msg, type });

  const addToCart = (product) => {
    if (product.stock <= 0) return showToast("Sem estoque!", "error");
    setCart(prev => {
      const exists = prev.find(i => i.id === product.id);
      if (exists) return prev.map(i => i.id === product.id ? { ...i, qty: i.qty + 1 } : i);
      showToast("Adicionado!");
      return [...prev, { ...product, qty: 1 }];
    });
  };

  const handleProductSave = (data) => {
    if (!data.name) return showToast("Nome obrigat√≥rio", "error");
    const clean = { ...data, stock: Number(data.stock), cost: Number(data.cost), price: Number(data.price) };
    if (productModal.data) setProducts(prev => prev.map(p => p.id === productModal.data.id ? { ...clean, id: p.id } : p));
    else setProducts(prev => [...prev, { ...clean, id: Date.now() }]);
    setProductModal({ open: false, data: null });
    showToast("Salvo!");
  };

  const handleProductDelete = (id) => {
    setConfirmDialog({ title: "Excluir?", message: "Essa a√ß√£o √© irrevers√≠vel.", onConfirm: () => { setProducts(prev => prev.filter(p => p.id !== id)); setProductModal({open:false}); setConfirmDialog(null); showToast("Exclu√≠do!"); }, onCancel: () => setConfirmDialog(null) });
  };

  const handleCustomerSave = (data) => {
    if (!data.name) return showToast("Nome obrigat√≥rio", "error");
    if (customerModal.data) setCustomers(prev => prev.map(c => c.id === customerModal.data.id ? { ...c, ...data } : c));
    else setCustomers(prev => [...prev, { ...data, id: Date.now(), debt: 0 }]);
    setCustomerModal({ open: false, data: null });
    showToast("Salvo!");
  };

  const handleFinalizeSale = () => {
    if (saleType === 'credit' && !selectedCustomer) return showToast("Selecione um cliente", "error");
    const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
    
    const newProducts = products.map(p => {
      const item = cart.find(c => c.id === p.id);
      return item ? { ...p, stock: p.stock - item.qty } : p;
    });

    if (saleType === 'credit') {
      setCustomers(prev => prev.map(c => c.id === selectedCustomer.id ? { ...c, debt: c.debt + total } : c));
    }

    setTransactions(prev => [{ id: Date.now(), type: 'sale', date: new Date().toISOString(), total, method: saleType, customerName: selectedCustomer ? selectedCustomer.name : 'Avulso', items: cart }, ...prev]);
    setProducts(newProducts);
    setCart([]);
    setCheckoutOpen(false);
    setSelectedCustomer(null);
    setSaleType('cash');
    setActiveTab('history');
    showToast("Venda realizada!");
  };

  const stats = useMemo(() => {
    const today = new Date().toDateString();
    return {
      sales: transactions.filter(t => t.type === 'sale' && t.method === 'cash' && new Date(t.date).toDateString() === today).reduce((a, b) => a + b.total, 0),
      debt: customers.reduce((a, b) => a + b.debt, 0)
    };
  }, [transactions, customers]);

  return (
    <ErrorBoundary>
      <div className="flex-1 h-full overflow-hidden flex flex-col bg-slate-50 font-sans text-slate-900">
        
        {/* CONTE√öDO PRINCIPAL (Scroll√°vel) */}
        <div className="flex-1 overflow-y-auto custom-scrollbar pb-24">
          
          {/* HOME */}
          {activeTab === 'home' && (
            <div className="p-5 pt-safe animate-fade-in">
              <header className="flex justify-between items-center mb-6">
                <div><h1 className="text-2xl font-bold text-slate-800">Revenda+</h1><p className="text-slate-500 text-sm">Painel do Dia</p></div>
                <button onClick={() => setActiveTab('settings')} className="bg-white p-3 rounded-full text-slate-600 border border-slate-100 shadow-sm hover:bg-slate-50 transition-colors"><Settings className="w-6 h-6"/></button>
              </header>
              <div className="grid grid-cols-2 gap-3 mb-6">
                <StatCard title="Vendas Hoje" value={formatCurrency(stats.sales)} icon={TrendingUp} colorClass="text-emerald-600" bgClass="bg-emerald-50" />
                <StatCard title="A Receber" value={formatCurrency(stats.debt)} icon={Users} colorClass="text-rose-500" bgClass="bg-rose-50" />
              </div>
              <button onClick={() => setActiveTab('sales')} className="w-full bg-purple-600 text-white p-4 rounded-2xl shadow-lg shadow-purple-200 flex items-center justify-center gap-2 mb-8 font-bold active:scale-95 transition-transform"><Plus className="w-6 h-6"/> Nova Venda</button>
              <h3 className="font-bold text-slate-700 mb-3">Estoque Cr√≠tico</h3>
              {products.filter(p => p.stock <= 2).map(p => (
                <div key={p.id} className="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center mb-2 shadow-sm">
                  <div><span className="text-[10px] font-bold text-slate-400 uppercase">{p.brand}</span><h4 className="font-bold text-slate-800 text-sm">{p.name}</h4></div>
                  <span className="bg-rose-100 text-rose-700 px-2 py-1 rounded-lg text-xs font-bold">{p.stock} un</span>
                </div>
              ))}
            </div>
          )}

          {/* LISTAS (Produtos/Clientes) */}
          {activeTab === 'products' && (
            <div className="p-5 pt-safe">
              <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Estoque</h2><button onClick={() => setProductModal({open:true, data:null})} className="bg-purple-600 text-white p-2 rounded-xl shadow"><Plus/></button></div>
              <input className="w-full pl-4 p-3 rounded-xl bg-white border border-slate-200 shadow-sm mb-4 outline-none" placeholder="Buscar..." value={productSearch} onChange={e => setProductSearch(e.target.value)} />
              <div className="space-y-2">
                {products.filter(p => p.name.toLowerCase().includes(productSearch.toLowerCase())).map(p => (
                  <div key={p.id} onClick={() => setProductModal({open:true, data:p})} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center active:bg-slate-50">
                    <div><h4 className="font-bold text-slate-800">{p.name}</h4><p className="text-purple-600 font-bold text-xs">{formatCurrency(p.price)}</p></div>
                    <span className="font-bold text-slate-600">{p.stock}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === 'customers' && (
            <div className="p-5 pt-safe">
              <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Clientes</h2><button onClick={() => setCustomerModal({open:true, data:null})} className="bg-purple-600 text-white p-2 rounded-xl shadow"><Plus/></button></div>
              <div className="space-y-3">
                {customers.map(c => (
                  <div key={c.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm" onClick={() => setCustomerModal({open:true, data:c})}>
                    <div className="flex justify-between">
                      <div><h4 className="font-bold text-slate-800">{c.name}</h4><p className="text-xs text-slate-400">{c.phone}</p></div>
                      <p className="text-rose-600 font-bold">{formatCurrency(c.debt)}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* VENDAS */}
          {activeTab === 'sales' && (
            <div className="p-5 pt-safe">
              <h2 className="text-2xl font-bold mb-4">Nova Venda</h2>
              <div className="flex gap-2 mb-4">
                <input className="flex-1 pl-4 p-3 rounded-xl bg-white border border-slate-200 shadow-sm outline-none" placeholder="Buscar..." value={saleSearch} onChange={e => setSaleSearch(e.target.value)} />
                <button onClick={() => setScanner({open:true, context:'search'})} className="bg-slate-800 text-white p-3 rounded-xl"><ScanBarcode/></button>
              </div>
              <div className="space-y-2 pb-20">
                {products.filter(p => p.name.toLowerCase().includes(saleSearch.toLowerCase())).map(p => {
                  const inCart = cart.find(i => i.id === p.id);
                  return (
                    <div key={p.id} onClick={() => addToCart(p)} className={`bg-white p-3 rounded-xl border flex justify-between items-center ${inCart ? 'border-purple-500 bg-purple-50' : 'border-slate-100'}`}>
                      <div><h4 className="font-medium">{p.name}</h4><p className="text-purple-600 font-bold text-sm">{formatCurrency(p.price)}</p></div>
                      {inCart ? <div className="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">{inCart.qty}</div> : <div className="bg-slate-100 text-slate-400 w-8 h-8 rounded-full flex items-center justify-center"><Plus className="w-5 h-5"/></div>}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {activeTab === 'history' && (
            <div className="p-5 pt-safe">
              <h2 className="text-2xl font-bold mb-6">Hist√≥rico</h2>
              <div className="space-y-3">
                {transactions.map(t => (
                  <div key={t.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div className="flex gap-3 items-center">
                      <div className={`p-2 rounded-full ${t.type === 'sale' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}`}>{t.type === 'sale' ? <ShoppingCart className="w-4 h-4"/> : <Check className="w-4 h-4"/>}</div>
                      <div><p className="font-bold text-sm">{t.type === 'sale' ? 'Venda' : 'Pagamento'}</p><p className="text-xs text-slate-400">{formatDate(t.date)}</p></div>
                    </div>
                    <p className="font-bold text-slate-700">{formatCurrency(t.total)}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {activeTab === 'settings' && (
            <div className="fixed inset-0 bg-slate-50 z-50 flex flex-col animate-slide-up">
              <div className="p-4 bg-white shadow-sm flex items-center pt-safe gap-3">
                <button onClick={() => setActiveTab('home')} className="p-2 -ml-2 text-slate-400"><ArrowLeft className="w-6 h-6"/></button>
                <h2 className="text-xl font-bold text-slate-800">Configura√ß√µes</h2>
              </div>
              <div className="p-5 overflow-y-auto">
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4">
                  <h3 className="font-bold mb-2">Backup</h3>
                  <p className="text-sm text-slate-500 mb-4">Salve seus dados ou restaure em outro aparelho.</p>
                  <div className="flex gap-2">
                    <button onClick={() => {
                      const data = JSON.stringify({ products, customers, transactions });
                      const blob = new Blob([data], {type: 'application/json'});
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a'); a.href = url; a.download = 'backup-revenda.json'; a.click();
                    }} className="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg font-bold text-sm">Baixar</button>
                    <label className="flex-1 bg-emerald-50 text-emerald-600 py-2 rounded-lg font-bold text-sm text-center cursor-pointer">
                      Restaurar
                      <input type="file" className="hidden" onChange={(e) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                          try {
                            const d = JSON.parse(ev.target.result);
                            if(confirm('Restaurar backup?')) { setProducts(d.products); setCustomers(d.customers); setTransactions(d.transactions); window.location.reload(); }
                          } catch { alert('Erro no arquivo'); }
                        };
                        if(e.target.files[0]) reader.readAsText(e.target.files[0]);
                      }}/>
                    </label>
                  </div>
                </div>
                <button onClick={() => setInstallModal(true)} className="w-full bg-slate-900 text-white p-4 rounded-xl font-bold flex items-center justify-center gap-2"><Smartphone/> Instalar App</button>
              </div>
            </div>
          )}
        </div>

        {/* BOTTOM NAV */}
        <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 px-6 pt-1 pb-safe flex justify-between items-center z-40 md:max-w-md md:mx-auto">
          {/* Home */}
          <button onClick={() => setActiveTab('home')} className={`group flex flex-col items-center p-2 w-14 transition-colors ${activeTab === 'home' ? 'text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>
            <Home className={`w-6 h-6 mb-1 ${activeTab === 'home' ? 'fill-purple-100' : ''}`}/>
            <span className="text-[10px] font-bold">In√≠cio</span>
          </button>

          {/* Products */}
          <button onClick={() => setActiveTab('products')} className={`group flex flex-col items-center p-2 w-14 transition-colors ${activeTab === 'products' ? 'text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>
            <Package className={`w-6 h-6 mb-1 ${activeTab === 'products' ? 'fill-purple-100' : ''}`}/>
            <span className="text-[10px] font-bold">Estoque</span>
          </button>

          {/* Center Action (Sales) */}
          <div className="relative -top-6">
            <button onClick={() => setActiveTab('sales')} className="bg-purple-600 text-white w-14 h-14 rounded-full shadow-lg shadow-purple-300 flex items-center justify-center transform active:scale-90 transition-transform border-4 border-slate-50">
              <ShoppingCart className="w-6 h-6"/>
            </button>
          </div>

          {/* Customers */}
          <button onClick={() => setActiveTab('customers')} className={`group flex flex-col items-center p-2 w-14 transition-colors ${activeTab === 'customers' ? 'text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>
            <Users className={`w-6 h-6 mb-1 ${activeTab === 'customers' ? 'fill-purple-100' : ''}`}/>
            <span className="text-[10px] font-bold">Fiado</span>
          </button>

          {/* History (Replaces Settings) */}
          <button onClick={() => setActiveTab('history')} className={`group flex flex-col items-center p-2 w-14 transition-colors ${activeTab === 'history' ? 'text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>
            <Clock className={`w-6 h-6 mb-1 ${activeTab === 'history' ? 'fill-purple-100' : ''}`}/>
            <span className="text-[10px] font-bold">Vendas</span>
          </button>
        </nav>

        {/* CHECKOUT FLUTUANTE */}
        {cart.length > 0 && activeTab === 'sales' && (
          <div className="fixed bottom-24 left-4 right-4 z-30 md:max-w-md md:mx-auto animate-slide-up">
            <button onClick={() => setCheckoutOpen(true)} className="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex justify-between items-center">
              <div className="flex items-center gap-3"><div className="bg-slate-700 w-10 h-10 rounded-full flex items-center justify-center font-bold">{cart.reduce((a,b)=>a+b.qty,0)}</div><span className="font-bold text-lg">{formatCurrency(cart.reduce((a,b)=>a+(b.price*b.qty),0))}</span></div>
              <div className="flex items-center gap-2 font-bold text-emerald-400 text-sm uppercase">Finalizar <ChevronRight className="w-5 h-5"/></div>
            </button>
          </div>
        )}

        {/* MODAIS (Overlays) */}
        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        {confirmDialog && <ConfirmModal {...confirmDialog} />}
        {productModal.open && <ProductForm data={productModal.data} onSave={handleProductSave} onDelete={handleProductDelete} onCancel={() => setProductModal({open:false, data:null})} />}
        {customerModal.open && <CustomerForm data={customerModal.data} onSave={handleCustomerSave} onDelete={() => {}} onCancel={() => setCustomerModal({open:false, data:null})} />}
        
        {checkoutOpen && (
          <div className="fixed inset-0 bg-black/60 z-50 flex items-end md:items-center justify-center md:max-w-md md:mx-auto">
            <div className="bg-white w-full rounded-t-3xl md:rounded-3xl p-6 animate-slide-up pb-safe max-h-[80vh] flex flex-col">
              <div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Resumo</h2><button onClick={() => setCheckoutOpen(false)}><X className="w-6 h-6"/></button></div>
              <div className="overflow-y-auto mb-4 border-b border-slate-100 pb-2 flex-1 space-y-2 custom-scrollbar">
                {cart.map(i => (<div key={i.id} className="flex justify-between text-sm"><span><b className="text-purple-600">{i.qty}x</b> {i.name}</span><span className="font-bold">{formatCurrency(i.price*i.qty)}</span></div>))}
              </div>
              <div className="flex gap-2 mb-4 shrink-0">
                <button onClick={() => setSaleType('cash')} className={`flex-1 py-3 border rounded-xl font-bold ${saleType === 'cash' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200 text-slate-400'}`}>√Ä Vista</button>
                <button onClick={() => setSaleType('credit')} className={`flex-1 py-3 border rounded-xl font-bold ${saleType === 'credit' ? 'bg-rose-50 border-rose-500 text-rose-700' : 'border-slate-200 text-slate-400'}`}>Fiado</button>
              </div>
              {saleType === 'credit' && <div className="mb-4 overflow-y-auto max-h-32 border rounded-xl border-slate-200 shrink-0 custom-scrollbar">{customers.map(c => (<div key={c.id} onClick={() => setSelectedCustomer(c)} className={`p-3 flex justify-between items-center cursor-pointer border-b border-slate-50 last:border-0 ${selectedCustomer?.id === c.id ? 'bg-purple-50' : ''}`}><span className="font-medium text-sm">{c.name}</span>{selectedCustomer?.id === c.id && <Check className="w-4 h-4 text-purple-600"/>}</div>))}</div>}
              <button onClick={handleFinalizeSale} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl shrink-0">Confirmar</button>
            </div>
          </div>
        )}

        {installModal && (
          <div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 animate-fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl p-6 text-center shadow-2xl">
              <div className="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600"><Smartphone className="w-8 h-8"/></div>
              <h3 className="text-xl font-bold text-slate-900 mb-2">Instalar App</h3>
              <p className="text-slate-500 mb-6 text-sm">Toque no menu do navegador e escolha <b>Adicionar √† Tela de In√≠cio</b>.</p>
              <button onClick={() => setInstallModal(false)} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold">Entendi</button>
            </div>
          </div>
        )}
      </div>
    </ErrorBoundary>
  );
}